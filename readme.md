---
author: ainski
time: 2025-12-10
teacher: qgf
note: 这一份cpu未借鉴任何学长代码，还请放心食用
---

# 流水线CPU设计项目
## 项目概述

这是一个用Verilog实现的流水线MIPS样CPU。设计遵循经典的5级流水线架构（IF：指令获取，ID：指令译码，EX：执行，MEM：内存访问，WB：写回），各阶段之间有各种流水线寄存器来存储中间结果。

## 架构设计

### 5级流水线设计
- **IF（指令获取）**: 从指令内存获取指令
- **ID（指令译码）**: 译码指令并从寄存器文件读取数据
- **EX（执行）**: 执行ALU操作和计算地址
- **MEM（内存访问）**: 访问数据内存以进行加载/存储操作
- **WB（写回）**: 将结果写回寄存器文件

### 主要组件

- **ALU.v**: 执行各种算术和逻辑运算的算术逻辑单元
- **regfile.v**: 具有转发和冒险检测功能的32寄存器寄存器文件
- **PCreg.v**: 管理指令地址序列的程序计数器模块
- **流水线寄存器**:
  - IF_ID.v: 指令获取到指令译码寄存器
  - ID_EX.v: 指令译码到执行寄存器
  - EX_MEM.v: 执行到内存寄存器
  - MEM_WB.v: 内存到写回寄存器
- **内存模块**:
  - IMEM.v: 指令内存
  - DMEM.v: 数据内存
- **def.v**: 包含操作码、ALU控制信号和其他常量的定义文件
- **sccomp_dataflow.v**: 集成所有组件的顶层模块
- **NPCmaker.v**: 处理跳转和分支的下程序计数器生成器
- **BJudge.v**: 条件分支的分支判断模块

### 支持的指令

CPU支持各种MIPS样指令，包括：

#### 算术运算指令：
- ADD, ADDU, SUBU
- ADDI, ADDIU

#### 移位运算指令：
- SLL

#### 加载/存储指令：
- LW, SW

#### 分支指令：
- BEQ, BNE

#### 比较指令：
- SLTU


#### 其他指令：
- NOP（编码为 SLL $0,$0,0）
- HALT（自定义指令）

## 实现特性

### 冒险处理
设计包含复杂的冒险检测和解决：

- **数据转发**: 在流水线阶段之间转发结果以减少停顿
- **加载使用冒险检测**: 对立即使用加载指令结果的情况进行特殊处理
- **停顿机制**: 当转发无法解决冒险时插入流水线气泡
- **寄存器冲突检测**: 防止写后写和读后写冲突

### 流水线控制
- 减少流水线停顿的转发逻辑
- 适当处理加载使用冒险
- 复杂的控制逻辑管理流水线操作和冒险检测

## 文件结构

```
cpupip8/
├── cpupip8.srcs/
│   └── sources_1/
│       └── new/                 # Verilog源文件
│           ├── alu.v           # 算术逻辑单元
│           ├── BJudge.v        # 分支判断模块
│           ├── cpu.v           # CPU核心实现
│           ├── def.v           # 常量和定义
│           ├── DMEM.v          # 数据内存
│           ├── EX_MEM.v        # 流水线寄存器：执行到内存
│           ├── ID_EX.v         # 流水线寄存器：指令译码到执行
│           ├── IF_ID.v         # 流水线寄存器：指令获取到译码
│           ├── IMEM.v          # 指令内存
│           ├── MEM_WB.v        # 流水线寄存器：内存到写回
│           ├── NPCmaker.v      # 下程序计数器生成器
│           ├── PCreg.v         # 程序计数器寄存器
│           ├── regfile.v       # 带转发的寄存器文件
│           ├── sccomp_dataflow.v # 顶层模块
│           └── seg7x16.v       # 7段显示模块
├── testdata/                   # Hex格式的测试程序
├── test_scripts/results/       # 测试结果和比较
├── report/                     # 项目文档
├── run_cpu_tests.do            # ModelSim自动化脚本
└── readme.md                   # 本文件
```

## 构建和运行

本项目设计用于Xilinx Vivado的综合和仿真。构建和仿真的步骤：

1. 在Verilog仿真器（ModelSim/QuestaSim/Vivado Simulator）中打开项目
2. 编译项目中的所有Verilog文件
3. 将测试程序加载到指令内存中
4. 运行仿真以观察CPU行为
5. 分析结果以验证流水线操作的正确性

### 自动化测试

项目包含使用ModelSim的自动化测试：

```bash
vsim -c -do "do run_cpu_tests.do; quit" > log
```

此命令运行`run_cpu_tests.do`脚本中定义的所有测试，并将日志保存到`log`文件。

### 测试方法

自动化测试脚本：
1. 编译所有Verilog文件
2. 在各种指令上运行全面的测试套件
3. 将仿真结果与预期结果进行比较
4. 生成详细的比较报告
5. 创建测试结果摘要

测试文件包括：
- 1_addi.hex.txt, 2_addiu.hex.txt, 9_addu.hex.txt
- 11_beq.hex.txt, 12_bne.hex.txt（分支指令）
- 16.26_lwsw.hex.txt（加载/存储操作）
- 20_sll.hex.txt（移位操作）
- 22_sltu.hex.txt, 25_subu.hex.txt（比较操作）
- 101_swlwbnebeq.hex.txt, 102_regconflict.hex.txt, 103_regconflict_detected_2.hex.txt（多指令测试）

## 开发规范

- Verilog模块遵循标准命名约定，使用描述性名称
- 使用`def.v`定义所有常量以保持一致性
- 流水线寄存器使用适当的控制信号来管理数据流
- 通过停顿和转发机制处理冒险
- 使用时钟和复位信号进行同步操作

## 关键设计概念

- **流水线**: 5级流水线实现指令级并行
- **冒险处理**: 通过转发和停顿处理数据和控制冒险
- **转发**: 在流水线阶段之间转发结果以减少停顿
- **停顿**: 当转发无法解决冒险时插入流水线气泡
- **控制逻辑**: 复杂的控制逻辑管理流水线操作和冒险检测

## 测试结果

当前测试结果存储在`test_scripts/results/`中：
- 仿真结果: `*_sim_result.txt`
- 标准结果: `*_std_result.txt` 
- 比较结果: `*_comparison_result.txt`
- 摘要: `test_summary.txt`

## 已知问题
`test_summary.txt`没那么好用，原因是似乎sj老师提供的`txt_compare` 程序并没有很好地支持命令行。可以依次查看比较结果来判断程序是否正确。

## 参考资料

- 计算机组成原理（计算机系统结构实验）
- MIPS架构文档
- 《数字设计与计算机体系结构》教科书

## 贡献

本项目为计算机体系结构课程的教育目的而开发。欢迎贡献和改进。如果您发现问题或有建议，请提交拉取请求或提出问题。